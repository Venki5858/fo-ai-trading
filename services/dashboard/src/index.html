<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>NIFTY & BANKNIFTY Paper Trading</title>
    <style>
      body { font-family: Arial, sans-serif; background:#050816; color:#e5e7eb; }
      .row { display:flex; flex-wrap:wrap; }
      .card { background:#111827; padding:16px; margin:16px; border-radius:8px; flex:1 1 300px; }
      .signal.buy { color:#22c55e; }
      .signal.sell { color:#ef4444; }
      pre { background:#020617; padding:8px; border-radius:4px; max-height:200px; overflow:auto; }
      button { padding:8px 16px; margin-right:8px; border-radius:4px; border:none; cursor:pointer; }
      .buy-btn { background:#22c55e; color:#020617; }
      .sell-btn { background:#ef4444; color:#020617; }
      .pnl-positive { color:#22c55e; }
      .pnl-negative { color:#ef4444; }
    </style>
  </head>
  <body>
    <div class="row">
      <div class="card">
        <h2>NIFTY Signal</h2>
        <p>Price: <span id="nifty-price">-</span></p>
        <p>Signal: <span id="nifty-signal" class="signal">-</span></p>
        <p><span id="nifty-confidence">-</span></p>
        <button class="buy-btn" onclick="placeOrder('NIFTY','BUY')">Buy</button>
        <button class="sell-btn" onclick="placeOrder('NIFTY','SELL')">Sell</button>
      </div>

      <div class="card">
        <h2>BANKNIFTY Signal</h2>
        <p>Price: <span id="banknifty-price">-</span></p>
        <p>Signal: <span id="banknifty-signal" class="signal">-</span></p>
        <p><span id="banknifty-confidence">-</span></p>
        <button class="buy-btn" onclick="placeOrder('BANKNIFTY','BUY')">Buy</button>
        <button class="sell-btn" onclick="placeOrder('BANKNIFTY','SELL')">Sell</button>
      </div>
    </div>

    <div class="card">
      <h3>Performance</h3>
      <p>Realized P&L: <span id="pnl" class="">0</span></p>
      <p>Closed trades: <span id="closed">0</span></p>
    </div>

    <div class="card">
      <h3>Orders</h3>
      <pre id="orders">[]</pre>
    </div>

    <div class="card">
      <h3>Positions</h3>
      <pre id="positions">{}</pre>
    </div>

    <script>
      async function fetchData() {
        try {
          const n = await fetch('http://localhost:8000/nifty');
          const nd = await n.json();
          document.getElementById('nifty-price').textContent = nd.price ?? '-';
          document.getElementById('nifty-signal').textContent = nd.prediction ?? '-';
          document.getElementById('nifty-signal').className = 'signal ' + (nd.prediction || '').toLowerCase();
          document.getElementById('nifty-confidence').textContent =
            nd.model ? `Model: ${nd.model} | Conf: ${(nd.confidence * 100).toFixed(0)}%` : '-';
        } catch (e) { console.log('nifty error', e); }

        try {
          const b = await fetch('http://localhost:8000/banknifty');
          const bd = await b.json();
          document.getElementById('banknifty-price').textContent = bd.price ?? '-';
          document.getElementById('banknifty-signal').textContent = bd.prediction ?? '-';
          document.getElementById('banknifty-signal').className = 'signal ' + (bd.prediction || '').toLowerCase();
          document.getElementById('banknifty-confidence').textContent =
            bd.model ? `Model: ${bd.model} | Conf: ${(bd.confidence * 100).toFixed(0)}%` : '-';
        } catch (e) { console.log('banknifty error', e); }

        try {
          const o = await fetch('http://localhost:5002/orders');
          const orders = await o.json();
          document.getElementById('orders').textContent = JSON.stringify(orders, null, 2);
        } catch (e) { console.log('orders error', e); }

        try {
          const p = await fetch('http://localhost:5002/positions');
          const positions = await p.json();
          document.getElementById('positions').textContent = JSON.stringify(positions, null, 2);
        } catch (e) { console.log('positions error', e); }

        try {
          const s = await fetch('http://localhost:5002/stats');
          const stats = await s.json();
          const pnlEl = document.getElementById('pnl');
          pnlEl.textContent = stats.realized_pnl.toFixed(2);
          pnlEl.className = stats.realized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
          document.getElementById('closed').textContent = stats.closed_trades;
        } catch (e) { console.log('stats error', e); }
      }

      async function placeOrder(symbol, side) {
        try {
          const r = await fetch(`http://localhost:8000/${symbol.toLowerCase()}`);
          const d = await r.json();
          await fetch('http://localhost:8000/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              symbol: symbol,
              side: side,
              quantity: 25,
              price: d.price
            })
          });
          await fetchData();
        } catch (e) { console.log('placeOrder error', e); }
      }

      fetchData();
      setInterval(fetchData, 5000);
    </script>
  </body>
</html>
